name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Run unit tests
        run: zig build test

      - name: Run unit tests (ReleaseFast)
        run: zig build test -Doptimize=ReleaseFast

  integration-tests:
    name: Integration Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build optimized binary
        run: zig build -Doptimize=ReleaseFast

      - name: Verify binary was built
        run: |
          ls -la zig-out/bin/
          file zig-out/bin/noemoji || echo "Binary not found!"
          
      - name: Make everything executable
        run: |
          chmod +x zig-out/bin/noemoji
          chmod +x tests/integration_test.sh
          chmod +x scripts/*.sh

      - name: Run integration tests
        run: bash tests/integration_test.sh zig-out/bin/noemoji

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Format check
        run: |
          zig fmt --check src/
          zig fmt --check tests/
          zig fmt --check build.zig

      - name: Build check
        run: |
          zig build -Doptimize=Debug
          zig build -Doptimize=ReleaseSafe
          zig build -Doptimize=ReleaseFast
          zig build -Doptimize=ReleaseSmall
